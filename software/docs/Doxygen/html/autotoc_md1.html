<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AgroPi: Design Document</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AgroPi
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Design Document </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Goal of this project is to create a flexible application which allows user to view enviroment variables on a website interface and controll the enviromnet from interface within a small chamber with actuating technology based on user's choice.</p>
<p>The base of application should conist of sensors able to sense the following:</p><ul>
<li>Light Intensity - This would be used as a hueristic for controlling light actuator</li>
<li>Temperature</li>
<li>Humidity</li>
<li>Co2 or eCo2</li>
<li>TVOC</li>
</ul>
<p>All sensors should utilize one protocol if possible this should be I2C/SMBUS. SPI Would be faster, however, extension would be required for RPi which would complicate design.</p>
<p>A base class is going to be created. This class is going to contain the following virtual functions to be overriden by each sensor class when inherting.</p><ul>
<li>Initialize - Opens the file descriptor to the sensor and does initial writes to sets up the sensor for reading operations.</li>
<li>Reset - Writes to sensor to set up initial state.</li>
<li>Close Device - Calls Reset function and closes the file descriptor</li>
</ul>
<p>The class is going to also following private variables:</p><ul>
<li>m_pI2CDriver - a pointer to I2C driver object.</li>
<li>m_fd - File Descriptor for I2C device.</li>
</ul>
<p>The I2C driver functions is going to be implemented as signle object, only one instance of the object is going to be initialized and reference to this object is going to be passed in initialization stage.</p>
<p>is going to contain methods for plain I2C writes as well as SMBUS</p>
<p>Flexibility is key, relay is going to be used to allow for user to connect desired actuaiting. 4 Channels is the minimmum and it is going to allow for the following:</p><ul>
<li>Lights</li>
<li>Heating Element</li>
<li>Fan</li>
<li>Water Pump</li>
</ul>
<p>The relay is going to be controlled by GPIO Pins.</p>
<p>The application must be multi-threaded. To avoid complexity in terms of concurency and communications:</p><ol type="1">
<li>All threads must be contained in a single process</li>
<li>Call-backs is going to be used where possible.</li>
</ol>
<p>Threads is going to idle most of the time and not execute constantly. This is can be achievied by interrupts, timers and blocking read operations.</p>
<p>Delay may be used only if it is absolotuley required(does not infulence/delay any other tasks), otherwise timers are the preffered choice.</p>
<p>Ideally an interrupt service routines is going to write to handle sensor interrupts. If Interrupt architecture cannot be realized then a a sampling is going to be implemented by a timer with an event function for whole I2C Bus. The sampling rate in such case is going to be at least 1Hz but preferablly 4Hz (Average human reaction time).</p>
<p>As soon as the timer fires the timer event function executes. The Timer event is going to do the following:</p><ol type="1">
<li>Gather data from each sensor by turn</li>
<li>Use controller callback function which sends data to server and executes the actuation loop.</li>
</ol>
<p><a class="el" href="classController.html" title="Controller class. ">Controller</a> object is going to contain the callback function for sampler object to use as well as set of functions to Tx &amp; Rx data to &amp; from web-server. <a class="el" href="classController.html" title="Controller class. ">Controller</a> is going to contain data structures holding latest environment data from sampler and hueristics passed from the user by the server. <a class="el" href="classController.html" title="Controller class. ">Controller</a> is going to contain relay object(s) and have set of functions to controll them.</p>
<p>jQuery -&gt; flask server -&gt; nginx -&gt; CGI handler -&gt; CPP</p>
<p><a class="el" href="classController.html" title="Controller class. ">Controller</a> thread should initialize the sampler and controller object, start sampling and go into a while loop which should execute based on an exit flag which is going to be able to controlled from web server. In this while loop thread is going to read data from the server. The Read operation for the server should be blocking and as soon as the messeage has been recieved it is going to be processed by striping the opcode and this opcode with the corresponding value should be passed to the event handler function.</p>
<p>Project is built on these technologies:</p>
<ul>
<li>Git<ul>
<li>Source control</li>
</ul>
</li>
<li>CMake<ul>
<li>Used as build tool</li>
<li>Doxygen generation</li>
</ul>
</li>
<li>Doxygen<ul>
<li>For documentation and API reference generation</li>
<li>Generates wiki from markdown files</li>
<li>Graphviz - for creating UML diagrams with doxygen</li>
</ul>
</li>
<li>cppcheck<ul>
<li>With <em>make cppcheck</em> you can run static code analysis</li>
</ul>
</li>
<li>Nginx<ul>
<li>Server which does post request for data and posts controll data</li>
</ul>
</li>
<li>Python<ul>
<li>Webserver</li>
</ul>
</li>
<li>Mongodb<ul>
<li>Databases</li>
</ul>
</li>
<li>OpenCV<ul>
<li>Capturing image from camera</li>
<li>Pattern recognition </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
